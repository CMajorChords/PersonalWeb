<h2 style='pointer-events: none;'>Darts中的可解释性</h2>

可解释性是深度学习模型能否落地的重要因素，由于安全问题，一个完全黑箱的网络很难被应用到水文预报中。本文将简单介绍Darts中的可解释性，并使用它来预测一个使用了CAMELS数据集进行径流预报的Tide(Time Series Dense Encoder)模型。
Explainability is an important factor for the deployment of deep learning models. Due to safety issues, a completely black-box network is difficult to apply to hydrological forecasting. In this article, explainability in Darts will be briefly introduced and used to predict a runoff forecast network trained with the CAMELS dataset.
<h3 style='pointer-events: none;'>Shap Explainer for RegressionModels in Darts</h3>

在 Darts 中，有两种可用的解释器：Shap和TFT Explainer。TFT Explainer是专门针对Temporal Fusion Transformer模型的解释器，这是由于Temporal Fusion Transformer的模型可解释性结构决定的，而Shap是一个通用的解释器，可以用于解释任何回归模型。
There are two available explainers in Darts: Shap and TFT Explainer. TFT Explainer is specifically designed for the Temporal Fusion Transformer model, which is due to the interpretable structure of the Temporal Fusion Transformer model, while Shap is a general explainer that can be used to explain any regression model. 

在Darts中，shap解释器是一个类，包含三个方法：
1. `explain()`: 针对Darts中的回归模型进行解释
2. `summary_plot()`: 生成一个shape plot summary，显示每个horizon和目标序列的每个组件维度的shap值
3. `force_flot_from_ts()`: 生成一个force plot，对于一个目标时间序列，显示每个lag和协变量的shap值

In Darts, the shap explainer is a class that contains three methods:
1. `explain()`: generates the explanations for a given foreground series (or background series, if foreground is not provided).
2. `summary_plot()`: displays a shap plot summary for each horizon and each component dimension of the target series.
3. `force_flot_from_ts()`: Generate a force plot that shows the shap value of each lag and covariate for a target time series

在初始化该类时，我们先认识两个定义：
* 一个background series是一个用于训练shap解释器的`TimeSeries`
* 一个foreground series是一个用于被shap解释器（已经被训练的）解释的`TimeSeries`

在Darts中，`ShapExplainer`仅仅指对回归模型有用，解释的*horizon*最多和`output_chunk_length`相等，从而得到每个预测延后窗口的SHAP值。`ShapExplainer`的初始化参数有：
* `model`: 一个`RegressionModel`，用于解释
* `background_series`: 一个`TimeSeries`，`TimeSeries`可以是单条时间序列，也可以是多条时间序列。考虑使用减少的精心选择的背景序列，以减少计算时间。对于默认选项，它是训练时的输入序列。如果模型是在一个装着很多target series的list上训练的，则该参数是必须的。
* `background_past_covariated`：一个过去协变量序列或者一个装着很多过去协变量序列的list。
* `background_future_covariates`：一个未来协变量序列或者一个装着很多未来协变量序列的list。
* `background_num_samples`：用于计算shap值的样本数。
* `shap_method`：计算shap值的方法，可以是"permutation", "partition", "tree", "kernel", "sampling", "linear", "deep", "gradient", "additive"。

When initializing this class, we first need to know two definitions:
* A background series is a `TimeSeries` used to train the shap explainer
* A foreground series is a `TimeSeries` to be explained by the shap explainer (already trained)

In Darts, `ShapExplainer` is only useful for regression models, and the explained *horizon* is at most equal to `output_chunk_length`, so that we get the SHAP values for each prediction lag window. The initialization parameters of `ShapExplainer` are:
* `model`: a `RegressionModel` to be explained.
* `background_series`: a `TimeSeries` that can be a single time series or multiple time series. Consider using a reduced, carefully selected background series to reduce computation time. For the default option, it is the input series at training time. If the model is trained on a list of many target series, this parameter is required.
* `background_past_covariates`: a past covariate series or a list of many past covariate series.
* `background_future_covariates`: a future covariate series or a list of many future covariate series.
* `background_num_samples`: the number of samples used to compute the shap values.
* `shap_method`: the method used to compute the shap values, which can be "permutation", "partition", "tree", "kernel", "sampling", "linear", "deep", "gradient", "additive".
<h3 style='pointer-events: none;'>简单例子</h3>

```
# %%import the necessary libraries
from darts.datasets import AirPassengersDataset
from darts.exlainability.shapecxplainer import ShapExplainer
from darts.models import LinearRegressionModel

# %%load the dataset
series = AirPassengersDataset().load()

# %%create and train a simple linear regression model
model = LinearRegressionModel()
model.fit(series[:-36])

# %%Use ShapExplainer to explain the model
shap_explain = ShapExplainer(model)
results = shap_explain.explain()
shap_explain.summary_plot()
shap_explain.force_flot_from_ts()
```
<h3 style='pointer-events: none;'>在用CAMELS数据集训练的Tide模型中使用ShapExplainer</h3>

```

