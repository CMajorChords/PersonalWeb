<h2 style='pointer-events: none;'>使用bagging和stacking的集成学习方法</h2>

autogluon是一个automl框架，它可以自动选择最佳的模型和超参数。在这个notebook中，我们将使用autogluon的时间序列预测功能来预测CAMELS数据集中的径流。我们将使用stacking和bagging技术来提高预测的精度。相比于HPO(超参数优化)，bagging和stacking技术更加简单但有效。autogluon使用的stacking技术有单层stacking和多层stacking。单层stacking使用多个模型的预测结果作为输入，然后使用一个线性模型来预测最终结果。多层stacking将多个模型的输出和数据合并起来再做一次stacking，最后用一个线性模型来预测最终结果。bagging技术是通过k则交叉验证来训练多个模型，然后将多个模型的预测结果取平均值。这样可以减小模型的方差，提高模型的稳定性。

值得注意的是，为了避免过拟合，多层stacking和k则交叉bagging通常是配合在一起使用的，也就是说stacking层中的每个模型都对应着一个fold上训练的模型，这个stacking层的输出其实是一个bagging模型和数据的组合输出。
<h3 style='pointer-events: none;'>lib和准备数据</h3>

输入libray


```
import pandas as pd
from autogluon.timeseries import TimeSeriesDataFrame, TimeSeriesPredictor
```

读取CAMELS数据集


```
rainfall_source = "daymet"
static_features = pd.read_csv(f"../data/static_features_{rainfall_source}.csv", dtype={"gauge_id": str})
varying_features = pd.read_csv(f"../data/varying_features_{rainfall_source}.csv", dtype={"gauge_id": str})
```
<h3 style='pointer-events: none;'>设置TimeSeriesDataFrame</h3>

```
static_features.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gauge_id</th>
      <th>elev_mean</th>
      <th>slope_mean</th>
      <th>area_gages2</th>
      <th>p_mean</th>
      <th>pet_mean</th>
      <th>aridity</th>
      <th>p_seasonality</th>
      <th>frac_snow</th>
      <th>high_prec_freq</th>
      <th>...</th>
      <th>soil_depth_pelletier</th>
      <th>soil_depth_statsgo</th>
      <th>soil_porosity</th>
      <th>soil_conductivity</th>
      <th>max_water_content</th>
      <th>sand_frac</th>
      <th>silt_frac</th>
      <th>clay_frac</th>
      <th>carbonate_rocks_frac</th>
      <th>geol_permeability</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01013500</td>
      <td>250.31</td>
      <td>21.64152</td>
      <td>2252.70</td>
      <td>3.126679</td>
      <td>1.971555</td>
      <td>0.630559</td>
      <td>0.187940</td>
      <td>0.313440</td>
      <td>12.95</td>
      <td>...</td>
      <td>7.404762</td>
      <td>1.248408</td>
      <td>0.461149</td>
      <td>1.106522</td>
      <td>0.558055</td>
      <td>27.841827</td>
      <td>55.156940</td>
      <td>16.275732</td>
      <td>0.000000</td>
      <td>-14.7019</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01022500</td>
      <td>92.68</td>
      <td>17.79072</td>
      <td>573.60</td>
      <td>3.608126</td>
      <td>2.119256</td>
      <td>0.587356</td>
      <td>-0.114530</td>
      <td>0.245259</td>
      <td>20.55</td>
      <td>...</td>
      <td>17.412808</td>
      <td>1.491846</td>
      <td>0.415905</td>
      <td>2.375005</td>
      <td>0.626229</td>
      <td>59.390156</td>
      <td>28.080937</td>
      <td>12.037646</td>
      <td>0.000000</td>
      <td>-14.2138</td>
    </tr>
    <tr>
      <th>2</th>
      <td>01030500</td>
      <td>143.80</td>
      <td>12.79195</td>
      <td>3676.17</td>
      <td>3.274405</td>
      <td>2.043594</td>
      <td>0.624111</td>
      <td>0.047358</td>
      <td>0.277018</td>
      <td>17.15</td>
      <td>...</td>
      <td>19.011414</td>
      <td>1.461363</td>
      <td>0.459091</td>
      <td>1.289807</td>
      <td>0.653020</td>
      <td>32.235458</td>
      <td>51.779182</td>
      <td>14.776824</td>
      <td>0.052140</td>
      <td>-14.4918</td>
    </tr>
    <tr>
      <th>3</th>
      <td>01031500</td>
      <td>247.80</td>
      <td>29.56035</td>
      <td>769.05</td>
      <td>3.522957</td>
      <td>2.071324</td>
      <td>0.587950</td>
      <td>0.104091</td>
      <td>0.291836</td>
      <td>18.90</td>
      <td>...</td>
      <td>7.252557</td>
      <td>1.279047</td>
      <td>0.450236</td>
      <td>1.373292</td>
      <td>0.559123</td>
      <td>35.269030</td>
      <td>50.841232</td>
      <td>12.654125</td>
      <td>0.026258</td>
      <td>-14.8410</td>
    </tr>
    <tr>
      <th>4</th>
      <td>01047000</td>
      <td>310.38</td>
      <td>49.92122</td>
      <td>909.10</td>
      <td>3.323146</td>
      <td>2.090024</td>
      <td>0.628929</td>
      <td>0.147776</td>
      <td>0.280118</td>
      <td>20.10</td>
      <td>...</td>
      <td>5.359655</td>
      <td>1.392779</td>
      <td>0.422749</td>
      <td>2.615154</td>
      <td>0.561181</td>
      <td>55.163133</td>
      <td>34.185443</td>
      <td>10.303622</td>
      <td>0.000000</td>
      <td>-14.4819</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 29 columns</p>
</div>




```
varying_features.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Year</th>
      <th>Mnth</th>
      <th>Day</th>
      <th>prcp(mm/day)</th>
      <th>srad(W/m2)</th>
      <th>tmax(C)</th>
      <th>tmin(C)</th>
      <th>vp(Pa)</th>
      <th>datetime</th>
      <th>gauge_id</th>
      <th>runoff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1980</td>
      <td>1</td>
      <td>1</td>
      <td>0.0</td>
      <td>153.40</td>
      <td>-6.54</td>
      <td>-16.30</td>
      <td>171.69</td>
      <td>1980-01-01</td>
      <td>01013500</td>
      <td>655.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1980</td>
      <td>1</td>
      <td>2</td>
      <td>0.0</td>
      <td>145.27</td>
      <td>-6.18</td>
      <td>-15.22</td>
      <td>185.94</td>
      <td>1980-01-02</td>
      <td>01013500</td>
      <td>640.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1980</td>
      <td>1</td>
      <td>3</td>
      <td>0.0</td>
      <td>146.96</td>
      <td>-9.89</td>
      <td>-18.86</td>
      <td>138.39</td>
      <td>1980-01-03</td>
      <td>01013500</td>
      <td>625.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1980</td>
      <td>1</td>
      <td>4</td>
      <td>0.0</td>
      <td>146.20</td>
      <td>-10.98</td>
      <td>-19.76</td>
      <td>120.06</td>
      <td>1980-01-04</td>
      <td>01013500</td>
      <td>620.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1980</td>
      <td>1</td>
      <td>5</td>
      <td>0.0</td>
      <td>170.43</td>
      <td>-11.29</td>
      <td>-22.21</td>
      <td>117.87</td>
      <td>1980-01-05</td>
      <td>01013500</td>
      <td>605.0</td>
    </tr>
  </tbody>
</table>
</div>




```
# 检查一下varying_features中的nan
varying_features.isna().sum()
```




    Year                0
    Mnth                0
    Day                 0
    prcp(mm/day)        0
    srad(W/m2)          0
    tmax(C)             0
    tmin(C)             0
    vp(Pa)              0
    datetime            0
    gauge_id            0
    runoff          40655
    dtype: int64




```
train_data = TimeSeriesDataFrame(
    data=varying_features[:-365],  # pandas.DataFrame, 必须
    static_features=static_features,  # 静态协变量, pandas.DataFrame，可选
    id_column="gauge_id",  # id列名，可选
    timestamp_column="datetime",  # 时间戳列名，可选
)
train_data.fill_missing_values(
    method="interpolate",
)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Year</th>
      <th>Mnth</th>
      <th>Day</th>
      <th>prcp(mm/day)</th>
      <th>srad(W/m2)</th>
      <th>tmax(C)</th>
      <th>tmin(C)</th>
      <th>vp(Pa)</th>
      <th>runoff</th>
    </tr>
    <tr>
      <th>item_id</th>
      <th>timestamp</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">01013500</th>
      <th>1980-01-01</th>
      <td>1980</td>
      <td>1</td>
      <td>1</td>
      <td>0.0</td>
      <td>153.40</td>
      <td>-6.54</td>
      <td>-16.30</td>
      <td>171.69</td>
      <td>655.0</td>
    </tr>
    <tr>
      <th>1980-01-02</th>
      <td>1980</td>
      <td>1</td>
      <td>2</td>
      <td>0.0</td>
      <td>145.27</td>
      <td>-6.18</td>
      <td>-15.22</td>
      <td>185.94</td>
      <td>640.0</td>
    </tr>
    <tr>
      <th>1980-01-03</th>
      <td>1980</td>
      <td>1</td>
      <td>3</td>
      <td>0.0</td>
      <td>146.96</td>
      <td>-9.89</td>
      <td>-18.86</td>
      <td>138.39</td>
      <td>625.0</td>
    </tr>
    <tr>
      <th>1980-01-04</th>
      <td>1980</td>
      <td>1</td>
      <td>4</td>
      <td>0.0</td>
      <td>146.20</td>
      <td>-10.98</td>
      <td>-19.76</td>
      <td>120.06</td>
      <td>620.0</td>
    </tr>
    <tr>
      <th>1980-01-05</th>
      <td>1980</td>
      <td>1</td>
      <td>5</td>
      <td>0.0</td>
      <td>170.43</td>
      <td>-11.29</td>
      <td>-22.21</td>
      <td>117.87</td>
      <td>605.0</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">14400000</th>
      <th>2013-12-27</th>
      <td>2013</td>
      <td>12</td>
      <td>27</td>
      <td>0.0</td>
      <td>162.94</td>
      <td>10.77</td>
      <td>3.15</td>
      <td>767.37</td>
      <td>398.0</td>
    </tr>
    <tr>
      <th>2013-12-28</th>
      <td>2013</td>
      <td>12</td>
      <td>28</td>
      <td>0.0</td>
      <td>166.67</td>
      <td>11.00</td>
      <td>3.18</td>
      <td>769.64</td>
      <td>384.0</td>
    </tr>
    <tr>
      <th>2013-12-29</th>
      <td>2013</td>
      <td>12</td>
      <td>29</td>
      <td>0.0</td>
      <td>192.28</td>
      <td>14.59</td>
      <td>4.39</td>
      <td>839.31</td>
      <td>368.0</td>
    </tr>
    <tr>
      <th>2013-12-30</th>
      <td>2013</td>
      <td>12</td>
      <td>30</td>
      <td>0.0</td>
      <td>184.12</td>
      <td>13.10</td>
      <td>3.83</td>
      <td>805.43</td>
      <td>355.0</td>
    </tr>
    <tr>
      <th>2013-12-31</th>
      <td>2013</td>
      <td>12</td>
      <td>31</td>
      <td>0.0</td>
      <td>177.34</td>
      <td>13.53</td>
      <td>4.78</td>
      <td>859.72</td>
      <td>342.0</td>
    </tr>
  </tbody>
</table>
<p>7977055 rows × 9 columns</p>
</div>




```
train_data.static_features["gauge_id"] = train_data.static_features["gauge_id"].astype(str)
```
<h3 style='pointer-events: none;'>设置TimeSeriesPredictor</h3>

```
known_covariates = [
    "Year",
    "Mnth",
    "Day",
    "prcp(mm/day)",
    "srad(W/m2)",
    "tmax(C)",
    "tmin(C)",
    "vp(Pa)",
]
predictor = TimeSeriesPredictor(
    target="runoff",
    prediction_length=7,
    eval_metric="RMSE",
    known_covariates_names=known_covariates,
    path="../models",
    verbosity=4,
    cache_predictions=True,
)
```
<h3 style='pointer-events: none;'>训练模型</h3>

```
TimeSeriesPredictor.fit(
    train_data=train_data,
    presets="best_quality",
    hyperparameters="default",
    num_val_windows=1,
    val_step_size=None,
    enable_ensemble=True,
    random_seed=42,
)
```
